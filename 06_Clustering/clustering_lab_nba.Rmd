---
title: "Clustering Lab"
author: "Po Wei Tsao"
date: "10/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Goal: Know how to make decisions and answer questions using clustering. 

# Repeat the clustering process only using the Rep house votes dataset
# - What differences and similarities did you see between how the clustering 
# worked for the datasets?

```{r}
library(tidyverse)
library(plotly)
library(htmltools)
library(devtools)
library(caret)
library(NbClust)
```

```{r}
#Load the data
nba_data = read.csv("../data/nba2020-21.csv")
# View(nba_data)

nba_salaries = read.csv("../data/nba_salaries_21.csv")
# View(nba_salaries)

combined_data = inner_join(nba_data, nba_salaries)
# View(combined_data)
```




```{r}
#Select the variables to be included in the cluster 
# cols = c("Player", "FG.", "eFG.", "FT.", "TRB", "AST", "STL", "BLK", "TOV", "PTS", "X2020.21")
cols = c("Player", "PTS", "BLK", "X2020.21")
clust_data_nba = combined_data[, cols]
clust_data_nba = clust_data_nba[complete.cases(clust_data_nba),]

# View(clust_data_nba)

standardize = function(data_in){
  #standardizing numeric data
  (new_data <- scale(data_in, center = TRUE, scale = TRUE))
  new_data
}


# nba_salaries["salaries_sc"] = standardize(nba_salaries[2])
# View(nba_salaries)
# nba_salaries = nba_salaries[ , !(names(nba_salaries) %in% c("X2020.21"))]
# View(nba_salaries)



numeric_cols = names(select_if(clust_data_nba, is.numeric))
clust_data_nba[numeric_cols] <- as_tibble(lapply(clust_data_nba[numeric_cols], standardize))
# standardized_nba_clust_data = do.call(rbind.data.frame, lapply(clust_data_nba, standardize))
# View(clust_data_nba)
standardized_complete_set = clust_data_nba


# View(nba_salaries)

# combined_data = inner_join(clust_data_nba, nba_salaries)


```

```{r}
#Start by trying to cluster the salary into 2 categorical variables (overpaid and underpaid)
clust_data_nba$X2020.21
?data.frame
nba_player_salary_clust = data.frame(clust_data_nba["X2020.21"])
set.seed(1)
salary_kmeans_obj = kmeans(nba_player_salary_clust, centers = 3, algorithm = "Lloyd", iter.max = 30)

salary_kmeans_obj
#Clustering the salaries into 3 clusters gives me a within cluster sum of squares by cluster of 90.6%.

salary_kmeans_obj$cluster
salary_cluster = as.factor(salary_kmeans_obj$cluster)

#plot out the salary clusters
?ggplot
ggplot(nba_player_salary_clust, aes(x = X2020.21, 
                            # y = X2020.21,
                            color = salary_cluster,
                            shape = salary_cluster)) + 
  geom_bar(size = 4) +
  ggtitle("Clusters of NBA Basketball Player salaries") +
  xlab("Standardized Salary of NBA basketball players") +
  scale_shape_manual(name = "Cluster", 
                     labels = c("Cluster 1", "Cluster 2", "Cluster 3"),
                     values = c("1", "2", "3")) +
  scale_color_manual(name = "Groups",         #<- tell R which colors to use and
                     #   which labels to include in the legend
                     labels = c("Cluster 1", "Cluster 2", "Cluster 3"),
                     values = c("red", "blue", "green")) +
  theme_light()

Player = standardized_complete_set["Player"]
player_salaries_cluster = data.frame(Player, salary_cluster)
# View(player_salaries_cluster)

salary_group = c("low pay", "middle pay", "high pay")
salary_cluster = c("1", "2", "3")
color = c("red", "blue", "green")

salary_cluster_labels = data.frame(salary_group,salary_cluster, color )
# salary_cluster_labels

salary_group_join_clusters = inner_join(player_salaries_cluster, salary_cluster_labels)
# salary_group_join_clusters

standardized_complete_set = inner_join(standardized_complete_set, salary_group_join_clusters)
standardized_complete_set = standardized_complete_set[ , !(names(standardized_complete_set) %in% c("salary_cluster"))]

# View(standardized_complete_set)


#As we can see, the salaries can be clustered into 3 categories.

  
```


```{r}
#Evaluate several different number of clusters
explained_variance = function(data_in, k){
  
  # Running the kmeans algorithm.
  set.seed(1)
  kmeans_obj = kmeans(data_in, centers = k, algorithm = "Lloyd", iter.max = 30)
  
  # Variance accounted for by clusters:
  # var_exp = intercluster variance / total variance
  var_exp = kmeans_obj$betweenss / kmeans_obj$totss
  var_exp  
}

player_names = clust_data_nba[0:1]
#str(player_names)

salaries = clust_data_nba$X2020.21
# View(salaries)

drops = c("Player", "salary_group", "X2020.21")
clust_data_nba = clust_data_nba[ , !(names(clust_data_nba) %in% drops)]

# View(clust_data_nba)

#Apply my function to the dataframe we have
explained_var_nba = sapply(1:10, explained_variance, data_in = clust_data_nba)

# View(explained_var_nba)


# Data for ggplot2.
# elbow_data_nba = data.frame(k = 1:10, explained_var_nba)
# View(explained_var_nba)
elbow_data_nba = data.frame(k = 1:10, explained_var_nba)
# View(elbow_data_nba)
```

```{r}
#Create a elbow chart of the output 
# View(explained_var_nba)
# View(explained_var_Dem)
# 
# View(elbow_data_Dem)
# View(elbow_data_nba)

# View(elbow_data_nba)
ggplot(elbow_data_nba, 
       aes(x = k,  
           y = explained_var_nba)) + 
  geom_point(size = 4) +           #<- sets the size of the data points
  geom_line(size = 1) +            #<- sets the thickness of the line
  xlab('k') + 
  ylab('Inter-cluster Variance / Total Variance') + 
  theme_light()

# With the elbow method, it looks like 2 or 4 clusters is a good choice
```



```{r}
set.seed(1)
kmeans_obj_nba_4clust = kmeans(clust_data_nba, centers = 4, 
                        algorithm = "Lloyd")   #<- there are several ways of implementing k-means, see the help menu for a full list
#! Lloyd = euclidean distance for clustering

kmeans_obj_nba_4clust
# Within cluster sum of squares by cluster: 73.3%


# View the results of each output of the kmeans function.
head(kmeans_obj_nba_4clust)

```
```{r}
salary_clusters_nba = as.factor(kmeans_obj_nba_4clust$cluster)

# What does the kmeans_obj look like?
# View(salary_clusters_nba)

#==================================================================================

#### Slide 29: Step 3: visualize plot ####

# View(standardized_complete_set)
# View(salary_clusters_nba)

# Points and Salary
ggplot(standardized_complete_set, aes(x = PTS, 
                            y = BLK,
                            color = salary_clusters_nba,
                            shape = salary_clusters_nba)) + 
  geom_point(size = 4) +
  ggtitle("Points gained vs Salary NBA basketball players") +
  xlab("Standardized Points Gained By Players") +
  ylab("Standardized Salary") +
  scale_shape_manual(name = "Cluster", 
                     labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
                     values = c("1", "2", "3", "4")) +
  scale_color_manual(name = "Groups",         #<- tell R which colors to use and
                     #   which labels to include in the legend
                     labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
                     values = c("red", "blue", "green", "black")) +
  theme_light()

# Points and Effective Field Goal Percentage
# ggplot(standardized_complete_set, aes(x = PTS, 
#                             y = eFG.,
#                             color = salary_clusters_nba,
#                             shape = salary_clusters_nba)) + 
#   geom_point(size = 4) +
#   ggtitle("Points gained vs Effective Field Goal Percentage") +
#   xlab("Standardized Points Gained By Players") +
#   ylab("Standardized Effective Field Goal Percentage") +
#   scale_shape_manual(name = "Cluster", 
#                      labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
#                      values = c("1", "2", "3", "4")) +
#   scale_color_manual(name = "Groups",         #<- tell R which colors to use and
#                      #   which labels to include in the legend
#                      labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
#                      values = c("red", "blue", "green", "black")) +
#   theme_light()

# Points and Blocks
ggplot(standardized_complete_set, aes(x = PTS, 
                            y = BLK,
                            color = salary_clusters_nba,
                            shape = salary_clusters_nba)) + 
  geom_point(size = 4) +
  ggtitle("Points gained vs Blocks") +
  xlab("Standardized Points Gained By Players") +
  ylab("Standardized Blocks Performed By Players") +
  scale_shape_manual(name = "Cluster", 
                     labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
                     values = c("1", "2", "3", "4")) +
  scale_color_manual(name = "Groups",         #<- tell R which colors to use and
                     #   which labels to include in the legend
                     labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
                     values = c("red", "blue", "green", "black")) +
  theme_light()
#
# ggplot(standardized_complete_set, aes(x = AST, 
#                             y = X2020.21,
#                             color = salary_clusters_nba,
#                             shape = salary_clusters_nba)) + 
#   geom_point(size = 4) +
#   ggtitle("Assists vs Salary NBA basketball players") +
#   xlab("Standardized Number of Assists Performed By Players") +
#   ylab("Standardized Salary") +
#   scale_shape_manual(name = "Cluster", 
#                      labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
#                      values = c("1", "2", "3", "4")) +
#   scale_color_manual(name = "Groups",         #<- tell R which colors to use and
#                      #   which labels to include in the legend
#                      labels = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
#                      values = c("red", "blue", "green", "black")) +
#   theme_light()



#cluster by salary first (low pay, medium pay, high pay)

#then cluster by performance and overlay salary cluster's color onto graph.
```

```{r}
#3D graph with Blocks, Points and Salary
View(standardized_complete_set)
salary_pts_blk_3d = standardized_complete_set
salary_pts_blk_3d$cluster = salary_clusters_nba
cluster_colors = data.frame(cluster = c("1", "2", "3"),
                               color = c("red", "blue", "green"))
salary_pts_blk_3d = inner_join(salary_pts_blk_3d, cluster_colors)

salary_pts_blk_3d$Player <- gsub("[^[:alnum:]]", "_", salary_pts_blk_3d$Player)

# View(salary_pts_blk_3d)
fig <- plot_ly(salary_pts_blk_3d, 
               type = "scatter3d",
               mode="markers",
               symbol = ~cluster,
               x = ~PTS, 
               y = ~X2020.21, 
               z = ~BLK,
               color = ~color,
               colors = c("#0000FF", '#00FF00','#FF0000'),
               text = ~paste('Player:',Player))


fig

```

```{r}
#Let's try out 2 clusters

set.seed(1)
kmeans_obj_nba_4clust = kmeans(clust_data_nba, centers = 2, 
                        algorithm = "Lloyd")   #<- there are several ways of implementing k-means, see the help menu for a full list
#! Lloyd = euclidean distance for clustering
# What did the kmeans function produce, 
# what does the new variable kmeans_obj contain?
kmeans_obj_nba_4clust
#! the output of this: 
    #!clustering vector: each row is classified as 1 or 2
    #!between_SS / total_SS = average variance of each point to its centers (??)


# View the results of each output of the kmeans function.
head(kmeans_obj_nba_4clust)

```


```{r}

#JUST TRYING THIS OUT. REMOVE IF NO LONGER NECESSARY

#Use NbClust to select a number of clusters
library(NbClust)

# Run NbClust.
(nbclust_obj_nba = NbClust(data = clust_data_nba, method = "kmeans"))

# View the output of NbClust.
nbclust_obj_nba

# View the output that shows the number of clusters each method recommends.
View(nbclust_obj_Dem$Best.nc)
```

```{r}
#Display the results visually
freq_k_nba = nbclust_obj_nba$Best.nc[1,]
freq_k_nba = data.frame(freq_k_nba)
View(freq_k_nba)

# Check the maximum number of clusters suggested.
max(freq_k_nba)

#essentially resets the plot viewer back to default
# dev.off()

# Plot as a histogram.
ggplot(freq_k_nba,
       aes(x = freq_k_nba)) +
  geom_bar() +
  scale_x_continuous(breaks = seq(0, 15, by = 1)) +
  scale_y_continuous(breaks = seq(0, 12, by = 1)) +
  labs(x = "Number of Clusters",
       y = "Number of Votes",
       title = "Cluster Analysis")
```

```{r}
#Using the recommended number of clusters and perform k-means clustering



```


```{r}
#Bonus: Create a 3d version of the output
```

```{r}
#! also do practice for the rep/dem data set and submit it.
```

In a separate Rmarkdown document work through a similar process 
with the NBA data (nba2020-21 and nba_salaries_21), merge them together. 

You are a scout for the worst team in the NBA, probably the Wizards. Your 
general manager just heard about Data Science and thinks it can solve all the
teams problems!!! She wants you to figure out a way to find players that are 
high performing but maybe not highly paid that you can steal to get the team 
to the playoffs! 

Details: 

- Determine a way to use clustering to estimate based on performance if 
players are under or over paid, generally. 
- Then select three players you believe would be best your team and explain why. 
- Provide a well commented and clean (knitted) report of your findings that can 
be presented to your GM. Include a rationale for variable selection, details 
on your approach and a overview of the results with supporting visualizations. 
- Create a new repo for this assignment either for yourself and 
submit the link along with your knitted report. 

Hints:

- Salary is the variable you are trying to understand 
- You can include numerous performance variables in the clustering but when 
interpreting you might want to use graphs that include variables that are the 
most correlated with Salary
- You'll need to standardize the variables before performing the clustering
- Be specific about why you selected the players that you did, more detail is 
better
- Use good coding practices, comment heavily, indent, don't use for loops unless
totally necessary and create modular sections that align with some outcome. If 
necessary create more than one script,list/load libraries at the top and don't 
include libraries that aren't used. 
  





